# Render.com Deployment Guide

## Quick Deploy to Render

### Prerequisites
- GitHub repository connected to Render
- Render account (free tier available)

### Deployment Options

#### Option 1: Blueprint Deploy (Recommended - Uses render.yaml)
1. Go to [Render Dashboard](https://dashboard.render.com)
2. Click "New" → "Blueprint"
3. Connect your GitHub repository
4. Render will detect `render.yaml` and create services automatically
5. Review settings and click "Apply"

#### Option 2: Manual Web Service
1. Go to Render Dashboard
2. Click "New" → "Web Service"
3. Connect repository: `matpng/ddd`
4. Configure:
   - **Name**: `orion-octave-cubes`
   - **Environment**: `Docker` (recommended) or `Python`
   - **Region**: Choose closest to users
   - **Branch**: `main`
   - **Build Command**: (leave empty for Docker)
   - **Start Command**: (uses Procfile automatically)
   - **Plan**: Free or Starter
5. Add environment variables (see below)
6. Click "Create Web Service"

---

## Environment Variables (Set in Render Dashboard)

### Required
```
SECRET_KEY=<auto-generated by Render>
FLASK_ENV=production
FLASK_DEBUG=false
```

### Optional (with defaults)
```
ENABLE_AUTONOMOUS=true
ENABLE_ML_DISCOVERY=true
DISCOVERY_INTERVAL=3600
ML_ANALYSIS_INTERVAL=7200
LOG_LEVEL=INFO
CACHE_ENABLED=true
CACHE_MAX_SIZE=100
MAX_DISTANCE_PAIRS=50000
MAX_DIRECTION_PAIRS=25000
WEB_CONCURRENCY=2
```

### CORS (if accessing from custom frontend)
```
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### WakaTime (if using)
```
WAKATIME_API_KEY=waka_863fa2ac-5a42-4799-9f49-49314540409b
```

**Important**: Add `ALLOWED_ORIGINS` if your frontend is on a different domain.

---

## Health Check Configuration

In Render dashboard:
- **Health Check Path**: `/health` or `/healthz`
- **Health Check Interval**: 30 seconds

The app provides lightweight health endpoints:
- `GET /health` - Returns `{"success": true, "status": "ok"}`
- `GET /healthz` - Alias for `/health`

---

## Deployment Workflow

### Auto-Deploy (Recommended)
1. Push to `main` branch on GitHub
2. Render automatically detects changes
3. Builds Docker image (or installs dependencies)
4. Runs health check
5. Routes traffic to new version

### Manual Deploy
1. Go to your service in Render Dashboard
2. Click "Manual Deploy" → "Deploy latest commit"

---

## Build Settings

### Docker (Recommended)
- Render uses `Dockerfile` automatically
- Installs system dependencies (build-essential)
- Installs Python packages from `requirements.txt`
- Health check built into Dockerfile

### Python Buildpack (Alternative)
- Uses `runtime.txt` for Python version (3.11.6)
- Uses `requirements.txt` for dependencies
- May fail for numpy/scipy if build environment lacks compilers
- **Only use if you can't use Docker**

---

## Monitoring Your Deployment

### Logs
```bash
# View logs in Render dashboard or via CLI
curl https://api.render.com/v1/services/<service-id>/logs \
  -H "Authorization: Bearer <api-key>"
```

### Metrics
Access built-in metrics:
- **Prometheus**: `https://your-app.onrender.com/metrics`
- **JSON Summary**: `https://your-app.onrender.com/api/metrics/summary`

### Health Status
```bash
curl https://your-app.onrender.com/health
# Returns: {"success": true, "status": "ok"}
```

---

## Scaling

### Free Tier Limitations
- Sleeps after 15 min of inactivity
- 750 hours/month free
- Limited CPU/memory
- No persistent disk

### Upgrade to Starter/Standard
```yaml
# In render.yaml, change:
plan: starter  # $7/month, no sleep, better resources
```

Or in dashboard: Service → Settings → Plan

### Horizontal Scaling
```yaml
# Increase workers in render.yaml or via env var
envVars:
  - key: WEB_CONCURRENCY
    value: 4  # More workers for concurrent requests
```

---

## Troubleshooting

### Build Fails (Dependencies)
**Problem**: numpy/scipy/matplotlib build errors

**Solution**: Use Docker environment (not Python buildpack)
```yaml
# In render.yaml
env: docker
```

### App Doesn't Start
**Problem**: Port binding error

**Check**: Gunicorn binds to `$PORT` environment variable
```bash
# Procfile should have:
web: gunicorn --bind 0.0.0.0:$PORT app:app
```

### Health Check Fails
**Problem**: `/` endpoint is slow (runs analysis)

**Solution**: Use `/health` endpoint (fast, no computation)
```
Health Check Path: /health
```

### Rate Limiting Issues
**Problem**: Too many 429 errors

**Solution**: Adjust rate limits in `security_middleware.py` or disable for trusted origins

### CORS Errors
**Problem**: Frontend can't access API

**Solution**: Add frontend domain to `ALLOWED_ORIGINS`
```
ALLOWED_ORIGINS=https://yourdomain.com
```

---

## Production Checklist

- [ ] Set `SECRET_KEY` (auto-generated by Render)
- [ ] Set `FLASK_ENV=production` and `FLASK_DEBUG=false`
- [ ] Configure `ALLOWED_ORIGINS` if using custom frontend
- [ ] Set health check path to `/health`
- [ ] Choose appropriate plan (free/starter/standard)
- [ ] Set `WEB_CONCURRENCY` based on plan resources
- [ ] Monitor logs during first deploy
- [ ] Test all endpoints after deploy
- [ ] Set up custom domain (optional)
- [ ] Configure monitoring/alerts (optional)

---

## Useful Commands

### Test Locally with Docker
```bash
# Build and run exactly as Render will
docker build -t orion-octave-cubes .
docker run -p 5000:5000 \
  -e FLASK_ENV=production \
  -e ENABLE_AUTONOMOUS=false \
  orion-octave-cubes
```

### Test Health Endpoint
```bash
curl http://localhost:5000/health
```

### View Prometheus Metrics
```bash
curl http://localhost:5000/metrics
```

### Test with Production Settings
```bash
# Set all required env vars
export SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_hex(32))')
export FLASK_ENV=production
export FLASK_DEBUG=false
export PORT=5000

# Run with gunicorn (like Render does)
gunicorn --bind 0.0.0.0:5000 --workers 2 --threads 4 app:app
```

---

## Additional Resources

- [Render Docs - Deploy from GitHub](https://render.com/docs/deploy-from-github)
- [Render Docs - Docker](https://render.com/docs/docker)
- [Render Docs - Environment Variables](https://render.com/docs/configure-environment-variables)
- [Render Docs - Health Checks](https://render.com/docs/health-checks)

---

## Support

If deployment fails:
1. Check Render build logs
2. Verify `Dockerfile` builds locally
3. Test health endpoint: `curl https://your-app.onrender.com/health`
4. Review environment variables in Render dashboard
5. Check [Render Status](https://status.render.com) for platform issues
